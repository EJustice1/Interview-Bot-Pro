<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth Test</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        input[type="email"], input[type="password"] {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;
        }
        button:hover { background-color: #0056b3; }
        #userInfo, #tokenInfo, #errorInfo { margin-top: 15px; padding: 10px; border-radius: 4px; }
        #userInfo { background-color: #e6fffa; border: 1px solid #00bfa5; }
        #tokenInfo { background-color: #e8f0fe; border: 1px solid #4285f4; word-break: break-all; }
        #errorInfo { background-color: #ffebee; border: 1px solid #f44336; color: #c62828; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Firebase Auth Test</h2>

        <div id="authForm">
            <h3>Sign Up / Sign In</h3>
            <input type="email" id="email" placeholder="Email" required><br>
            <input type="password" id="password" placeholder="Password" required><br>
            <button onclick="signUpUser()">Sign Up</button>
            <button onclick="signInUser()">Sign In</button>
        </div>

        <div id="userDetails" class="hidden">
            <h3>User Details</h3>
            <div id="userInfo"></div>
            <button onclick="signOutUser()">Sign Out</button>
            <hr>
            <h4>ID Token:</h4>
            <div id="tokenInfo"></div>
            <button onclick="verifyTokenOnBackend()">Test Token with Backend (Manual)</button>
            <button onclick="testRootEndpoint()">Test Root Endpoint (GET /)</button>
        </div>

        <div id="errorInfo" class="hidden"></div>
    </div>

    <!-- Import Firebase JS SDKs -->
    <!-- Replace with the latest SDK versions from the Firebase documentation -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; // Check for latest version
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut,
            getIdToken
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; // Check for latest version

        // TODO: Add your Firebase project's configuration object here:
        const firebaseConfig = {
            apiKey: "AIzaSyBoAJ5zSqKkb1nPhGVs8O9I26o0fvPQP6s",
            authDomain: "interviewbotpro-460106.firebaseapp.com",
            projectId: "interviewbotpro-460106",
            storageBucket: "interviewbotpro-460106.firebasestorage.app",
            messagingSenderId: "412586314779",
            appId: "1:412586314779:web:92d4a9965eb079a560bcbe"
        };

        function decodeJwt(token) {
            try {
                const base64Url = token.split('.')[1]; // Get the payload
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null; // Or handle error
            }
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // DOM Elements
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authForm = document.getElementById('authForm');
        const userDetailsDiv = document.getElementById('userDetails');
        const userInfoDiv = document.getElementById('userInfo');
        const tokenInfoDiv = document.getElementById('tokenInfo');
        const errorInfoDiv = document.getElementById('errorInfo');

        let currentIdToken = null;

        // --- Auth Functions ---
        window.signUpUser = async () => {
            hideError();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                console.log("User signed up:", userCredential.user);
                // User will be automatically signed in, onAuthStateChanged will handle UI
            } catch (error) {
                showError(error.message);
                console.error("Error signing up:", error);
            }
        };

        window.signInUser = async () => {
            hideError();
            try {
                const userCredential = await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                console.log("User signed in:", userCredential.user);
                // onAuthStateChanged will handle UI
            } catch (error) {
                showError(error.message);
                console.error("Error signing in:", error);
            }
        };

        window.signOutUser = async () => {
            hideError();
            try {
                await signOut(auth);
                console.log("User signed out");
                // onAuthStateChanged will handle UI
            } catch (error) {
                showError(error.message);
                console.error("Error signing out:", error);
            }
        };

        // Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                console.log("Auth state changed: User is signed in", user);
                userInfoDiv.textContent = `Email: ${user.email}, UID: ${user.uid}`;
                authForm.classList.add('hidden');
                userDetailsDiv.classList.remove('hidden');

                try {
                    currentIdToken = await getIdToken(user, true);
                    tokenInfoDiv.textContent = currentIdToken;
                    const decodedClientToken = decodeJwt(currentIdToken); 
                    console.log("CLIENT-SIDE Decoded ID Token:", decodedClientToken); 
                    console.log("CLIENT-SIDE Token Audience:", decodedClientToken ? decodedClientToken.aud : "Error decoding");
                } catch (error) {
                    console.error("Error getting ID token:", error);
                    tokenInfoDiv.textContent = "Error getting ID token.";
                    showError("Error getting ID token: " + error.message);
                }


                

            } else {
                // User is signed out
                console.log("Auth state changed: User is signed out");
                userInfoDiv.textContent = '';
                tokenInfoDiv.textContent = '';
                currentIdToken = null;
                authForm.classList.remove('hidden');
                userDetailsDiv.classList.add('hidden');
            }
        });

        // --- UI Helper Functions ---
        function showError(message) {
            errorInfoDiv.textContent = message;
            errorInfoDiv.classList.remove('hidden');
        }

        function hideError() {
            errorInfoDiv.textContent = '';
            errorInfoDiv.classList.add('hidden');
        }

        // --- Backend Test Function ---
        window.verifyTokenOnBackend = () => {
            if (!currentIdToken) {
                alert("No ID token available. Please sign in.");
                return;
            }
            
             // TODO: Replace "YOUR_API_GATEWAY_INVOKE_URL_FROM_TERRAFORM_OUTPUT" 
            // with the actual value of 'api_gateway_invoke_url' from your 'terraform output' command.
            // For example, if your invoke URL is https://my-gateway-abcdef.uc.gateway.dev,
            // then backendUrl will be "https://my-gateway-abcdef.uc.gateway.dev/verifyToken"
            const apiGatewayBaseUrl = "https://user-auth-gateway-59jf8ly3.uc.gateway.dev"; // Replace with your actual API Gateway invoke URL
            const backendUrl = `${apiGatewayBaseUrl}/auth/verifyToken`;

            // Actual fetch call to the backend (uncomment this block)
            if (!backendUrl || backendUrl.startsWith("YOUR_API_GATEWAY_INVOKE_URL_FROM_TERRAFORM_OUTPUT")) {
                alert("Backend URL not configured in the script. Please update 'apiGatewayBaseUrl' with your API Gateway invoke URL from Terraform output.");
                return;
            }
            fetch(backendUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentIdToken}`,
                    'Content-Type': 'application/json' // If your backend expects a body or this header
                },
                // body: JSON.stringify({ some_data: "optional" }) // If sending data
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(`Backend error: ${response.status} ${text}`) });
                }
                return response.json(); // Or response.text() if it's not JSON
            })
            .then(data => {
                console.log("Backend response:", data);
                alert("Backend verification successful! Response: " + JSON.stringify(data));
            })
            .catch(error => {
                console.error("Error verifying token with backend:", error);
                showError("Backend error: " + error.message);
                alert("Error verifying token with backend. See console and error message on page.");
            });
        };

        // --- Temporary Test Function for Root Endpoint ---
        window.testRootEndpoint = () => {
            hideError();
            const apiGatewayBaseUrl = "https://user-auth-gateway-59jf8ly3.uc.gateway.dev";
            const rootUrl = `${apiGatewayBaseUrl}/`;

            fetch(rootUrl, {
                method: 'GET',
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(`Root endpoint error: ${response.status} ${text}`); });
                }
                return response.text();
            })
            .then(data => {
                console.log("Root endpoint response:", data);
                alert("Root endpoint successful! Response: " + data);
            })
            .catch(error => {
                console.error("Error testing root endpoint:", error);
                showError("Root endpoint error: " + error.message);
                alert("Error testing root endpoint. See console and error message on page.");
            });
        };
    </script>
</body>
</html>